server:
  port: 8080

spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        # ============= ADMIN ROUTES =============

        # Admin Orders - Order Service
        - id: admin-orders
          uri: lb://ORDER-SERVICE
          predicates:
            - Path=/api/admin/orders/**
          filters:
            - RewritePath=/api/admin/orders/(?<segment>.*), /api/admin/orders/${segment}

        # Admin Dashboard Stats - Order Service
        - id: admin-dashboard
          uri: lb://ORDER-SERVICE
          predicates:
            - Path=/api/admin/dashboard/**
          filters:
            - RewritePath=/api/admin/dashboard/(?<segment>.*), /api/admin/dashboard/${segment}

        # Admin Operations Orders/Shipping - Order Service
        - id: admin-operations-orders
          uri: lb://ORDER-SERVICE
          predicates:
            - Path=/api/admin/operations/orders/**,/api/admin/operations/shipping/**
          filters:
            - RewritePath=/api/admin/operations/(?<segment>.*), /api/admin/operations/${segment}

        # Admin Customers - Customer Service
        - id: admin-customers
          uri: lb://CUSTOMER-SERVICE
          predicates:
            - Path=/api/admin/customers/**
          filters:
            - RewritePath=/api/admin/customers/(?<segment>.*), /api/admin/customers/${segment}

        # Admin Products/Catalog - Catalog Service
        - id: admin-products
          uri: lb://CATALOG-SERVICE
          predicates:
            - Path=/api/admin/products/**
          filters:
            - RewritePath=/api/admin/products/(?<segment>.*), /api/admin/products/${segment}

        - id: admin-catalog
          uri: lb://CATALOG-SERVICE
          predicates:
            - Path=/api/admin/catalog/**
          filters:
            - RewritePath=/api/admin/catalog/(?<segment>.*), /api/admin/catalog/${segment}

        # Admin Operations Inventory - Catalog Service
        - id: admin-operations-inventory
          uri: lb://CATALOG-SERVICE
          predicates:
            - Path=/api/admin/operations/inventory/**
          filters:
            - RewritePath=/api/admin/operations/(?<segment>.*), /api/admin/operations/${segment}

        # Admin Content - Catalog Service
        - id: admin-content
          uri: lb://CATALOG-SERVICE
          predicates:
            - Path=/api/admin/content/**
          filters:
            - RewritePath=/api/admin/content/(?<segment>.*), /api/admin/content/${segment}

        # ============= REGULAR SERVICE ROUTES =============

        # Order Service - Puerto 8091
        - id: order-service
          uri: lb://ORDER-SERVICE
          predicates:
            - Path=/api/orders/**
          filters:
            - RewritePath=/api/orders/(?<segment>.*), /api/orders/${segment}

        # Catalog Service - Puerto 8092
        - id: catalog-service
          uri: lb://CATALOG-SERVICE
          predicates:
            - Path=/api/catalog/**
          filters:
            - RewritePath=/api/catalog/(?<segment>.*), /api/catalog/${segment}

        # Customer Service - Puerto 8093
        - id: customer-service
          uri: lb://CUSTOMER-SERVICE
          predicates:
            - Path=/api/customers/**
          filters:
            - RewritePath=/api/customers/(?<segment>.*), /api/customers/${segment}

        # Payment Service - Puerto 8094
        - id: payment-service
          uri: lb://PAYMENT-SERVICE
          predicates:
            - Path=/api/payments/**
          filters:
            - RewritePath=/api/payments/(?<segment>.*), /api/payments/${segment}

        # Notification Service - Puerto 8095
        - id: notification-service
          uri: lb://NOTIFICATION-SERVICE
          predicates:
            - Path=/api/notifications/**
          filters:
            - RewritePath=/api/notifications/(?<segment>.*), /api/notifications/${segment}

        # Billing Service - Puerto 8096
        - id: billing-service
          uri: lb://BILLING-SERVICE
          predicates:
            - Path=/api/billing/**
          filters:
            - RewritePath=/api/billing/(?<segment>.*), /api/billing/${segment}

        # Security Service - Puerto 8097
        - id: security-service
          uri: lb://SECURITY-SERVICE
          predicates:
            - Path=/api/security/**
          filters:
            - RewritePath=/api/security/(?<segment>.*), /api/security/${segment}

        # Recommendation Service - Puerto 8098
        - id: recommendation-service
          uri: lb://RECOMMENDATION-SERVICE
          predicates:
            - Path=/api/recommendations/**
          filters:
            - RewritePath=/api/recommendations/(?<segment>.*), /api/recommendations/${segment}

        # Integration Service - Puerto 8086 (external network, direct URI)
        - id: integration-service
          uri: http://host.docker.internal:8086
          predicates:
            - Path=/api/integration/**
          filters:
            - RewritePath=/api/integration/(?<segment>.*), /api/integration/${segment}

      # CORS Configuration - Allow all for development
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            allowedHeaders: "*"
            exposedHeaders:
              - Authorization
              - Content-Type
            allowCredentials: false
            maxAge: 3600

      # Default filters applied to all routes
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin

# Eureka Client Configuration
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
    register-with-eureka: true
    fetch-registry: true
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${random.value}

# Actuator endpoints for health checks
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true

# Logging configuration
logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    com.allconnect.gateway: DEBUG
